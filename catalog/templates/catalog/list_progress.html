{% extends "base_generic.html" %}
{% block content %}
<main class="col-md-9 col-lg-10 px-0">
  <div class="d-flex flex-column align-items-start pt-4 pb-3 mb-3" style="background-color: #f5f7fa; border-bottom: solid 1px #e3e6ed;">

    <p class="px-md-5 mb-3" style="font-family: sans-serif; font-size: 1.553125rem; font-weight: 600;">QUẢN LÝ TIẾN ĐỘ</p>
    <div class="container-fluid px-md-5">
      <div class="row align-items-center">
          <div class="col-auto">
            <div class="d-flex align-items-center border rounded px-3" style="width: 250px; background: #FFFFFF; border-radius: 5px; border-color: #cbd0dd;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16" class="text-muted">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                </svg>
                <input type="text" id="search-input" class="form-control border-0 shadow-none bg-transparent ms-2" 
                placeholder="Tìm kiếm..." style="width: 250px; font-size: .8rem; font-family: 'Nunito'; border-radius: 5px; padding: 6px 12px; " 
                value="{{ search_query }}" />
            </div>
          </div>

          <div class="col"></div>
  
          <div class="col-auto d-flex">
              <a href="#" class="btn custom2-btn me-2" style="display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0;">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 0 1-.659 1.591l-5.432 5.432a2.25 2.25 0 0 0-.659 1.591v2.927a2.25 2.25 0 0 1-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 0 0-.659-1.591L3.659 7.409A2.25 2.25 0 0 1 3 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0 1 12 3Z" />
                  </svg>
              </a>
              <a href="#" data-bs-toggle="modal" data-bs-target="#uploadFileModal" class="btn custom2-btn me-2" style="display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="14" height="14" style="vertical-align: middle;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                  </svg>        
                  Nhập file
              </a>
              <a href="#" data-bs-toggle="modal" data-bs-target="#createProgressModal" class="btn custom-btn" style="display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="16" height="16" style="vertical-align: middle;">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  Thêm mới
              </a>
          </div>
      </div>
  </div>
</div>

  <!-- Modal Nhập File -->
  <div class="modal fade" id="uploadFileModal" tabindex="-1" role="dialog" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="uploadFileForm" method="post" action="" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadFileModalLabel">Nhập danh sách loại nguyên vật liệu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="form-group mb-2">
              <label for="file" class="mb-2">Chọn file Excel:</label>
              <input type="file" id="file" name="file" class="form-control" accept=".xls,.xlsx">
            </div>
            <div class="form-group mb-2">
              <label for="sheetUrl" class="mb-2">URL của Google Sheets:</label>
              <input type="text" id="sheetUrl" name="sheetUrl" class="form-control">
            </div>
            <div class="form-group mb-2">
              <small class="form-text text-muted">Lưu ý: Hãy đảm bảo rằng liên kết Google Sheets đã được mở ở chế độ công khai.</small>
            </div>
            <div class="form-group mb-2">
              <p>
                Tải file mẫu danh sách nguyên vật liệu <a href="https://docs.google.com/spreadsheets/d/1pQBsBDiwey72witdw3JYjbNa_uN1HRlnKRTd_-BRzro/edit?gid=1655250114#gid=1655250114" target="_blank">tại đây</a>.
              </p>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Hủy</button>
            <button type="submit" class="btn submit-btn" id="submitUploadFileBtn">Nhập & Đóng</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Tạo mới phiếu -->
  <div class="modal fade" id="createProgressModal" tabindex="-1" role="dialog" aria-labelledby="createProgressModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="max-width: 900px; width: 100%; height: 470px;">
        <div class="modal-content" style="height: 100%; overflow-y: auto;">
            <form id="createForm" method="post" action="" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="createProgressModalLabel" style="color:#CBA230">Thêm mới phiếu quản lý tiến độ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="height: calc(100% - 125spx); overflow-y: auto;">
                        <div class="row mb-2">
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="progress_code">Mã tiến độ:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <input type="text" id="progress_code" name="progress_code" class="form-control custom-input" value="{{ new_progress_code }}" readonly>
                            </div>
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="work_date">Ngày làm việc:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <input type="date" id="work_date" name="work_date" class="form-control custom-input" value="{{ current_time|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="tailor">Thợ may:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <select id="tailor" name="tailor" class="form-control" required>
                                    <option value="">-- Chọn thợ may --</option>
                                    {% for employee in employees %}
                                    <option value="{{ progress.progress_code }} - {{ employee.employee_name }}">{{ employee.employee_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="tailor">MTK:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <select id="design" name="design" class="form-control">
                                    <option value="">-- Chọn MTK --</option>
                                    {% for design_item in designs %}
                                        <option value="{{ design_item.design.design_code }} - {{ design_item.design.design_name }}" 
                                                data-colors="{{ design_item.colors|join:',' }}" 
                                                data-sizes="{{ design_item.sizes|join:',' }}">
                                            {{ design_item.design.design_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                                    <label for="color">Màu:</label>
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <select id="color" name="color" class="form-control" required>
                                        <option value="">-- Chọn Màu --</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-center">
                                    <label for="size">Size:</label>
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <select id="size" name="size" class="form-control" required>
                                        <option value="">-- Chọn Size --</option>
                                    </select>
                                </div>
                            </div>
                        <div class="row mb-2 align-items-start">
                            <div class="col-md-2">
                                <label for="design_name" class="form-label">Tên thiết kế:</label>
                            </div>
                            <div class="col-md-10">
                                <input type="text" id="design_name" name="design_name" class="form-control custom-input" readonly>
                            </div>
                        </div>          
                        <hr color="#dee2e6">            
                        <div class="row mb-2">
                            <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                                <label for="task_name">Công việc đã làm:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <select id="task_name" name="task_name" class="form-control" required>
                                    <option value="">-- Chọn Công việc đã làm --</option>
                                    <option value="Cắt rập">Cắt rập</option>  
                                    <option value="Cắt vải">Cắt vải</option>
                                    <option value="Sửa đồ cho khách">Sửa đồ cho khách</option>
                                    <option value="May mẫu">May mẫu</option>
                                    <option value="Sửa mẫu">Sửa mẫu</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="fabric">Số mét vải đã cắt:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <input type="number" id="main_fabric_meters" name="main_fabric_meters" class="form-control me-2" placeholder="Vải chính" min="0">
                                      <input type="number" id="lining_fabric_meters" name="lining_fabric_meters" class="form-control" placeholder="Vải lót" min="0">
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                                <label for="start_time">Bắt đầu:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <input type="time" id="start_time" name="start_time" class="form-control">
                            </div>
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="end_time">Kết thúc:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <input type="time" id="end_time" name="end_time" class="form-control" value="{{ current_hour_minute }}">
                            </div>
                        </div>                        
                        <div class="row mb-2">
                            <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                                <label for="status">Trạng thái:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <select id="status" name="status" class="form-control" required>
                                    <option value="">-- Chọn Trạng thái --</option>
                                    <option value="In Progress">Dang dở</option>  
                                    <option value="Completed">Hoàn thành</option>
                                </select>
                            </div>
                            <div class="col-md-2 d-flex align-items-center">
                                <label for="notes">Ghi chú:</label>
                            </div>
                            <div class="col-md-4 d-flex align-items-center">
                                <input type="text" id="notes" name="notes" class="form-control custom-input">
                            </div>
                        </div>
                </div>
                <div class="modal-footer">
                        <button type="button" class="btn cancel-btn" data-bs-dismiss="modal" style="width: 150px;">Hủy</button>
                        <button type="submit" class="btn submit-btn" id="submitAddProgressBtn" style="width: 150px;">Tạo mới & Đóng</button>
                </div>
              </form>
          </div>
      </div>
  </div>


  <!-- Bảng loại nguyên vật liệu -->
  {% if progress_page %}
  <div class="table-responsive scrollbar px-md-5">
    <table class="table">
      <thead>
        <tr>
          <th>
            <a href="?sort_field=progress_code&sort_order={% if current_sort_field == 'progress_code' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'progress_code' %}{{ current_sort_order }}{% endif %}">
              MÃ TIẾN ĐỘ
            </a>
          </th>
          <th>
            <a href="?sort_field=work_date&sort_order={% if current_sort_field == 'work_date' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'work_date' %}{{ current_sort_order }}{% endif %}">
              NGÀY
            </a>
          </th>
          <th>
            <a href="?sort_field=tailor__employee_name&sort_order={% if current_sort_field == 'tailor__employee_name' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'tailor__employee_name' %}{{ current_sort_order }}{% endif %}">
              THỢ MAY
            </a>
          </th>
          <th>
            <a href="?sort_field=design__design_name&sort_order={% if current_sort_field == 'design__design_name' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'design__design_name' %}{{ current_sort_order }}{% endif %}">
              TÊN MTK
            </a>
          </th>
          <th>
            <a href="?sort_field=task_name&sort_order={% if current_sort_field == 'task_name' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'task_name' %}{{ current_sort_order }}{% endif %}">
              CÔNG VIỆC
            </a>
          </th>
          <th>
            <a href="?sort_field=start_time&sort_order={% if current_sort_field == 'start_time' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'start_time' %}{{ current_sort_order }}{% endif %}">
              BẮT ĐẦU
            </a>
          </th>
          <th>
            <a href="?sort_field=end_time&sort_order={% if current_sort_field == 'end_time' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'end_time' %}{{ current_sort_order }}{% endif %}">
              KẾT THÚC
            </a>
          </th>
          <th>
            <a href="?sort_field=main_fabric_meters&sort_order={% if current_sort_field == 'main_fabric_meters' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'main_fabric_meters' %}{{ current_sort_order }}{% endif %}">
              SỐ MÉT VẢI <br> &nbsp;&nbsp; ĐÃ CẮT
            </a>
          </th>
          <th>
            <a href="?sort_field=status&sort_order={% if current_sort_field == 'status' and current_sort_order == 'asc' %}desc{% else %}asc{% endif %}"
               class="{% if current_sort_field == 'status' %}{{ current_sort_order }}{% endif %}">
              TRẠNG THÁI
            </a>
          </th>
          <th>
          </th>
        </tr>
      </thead>
      <tbody>
        {% for progress in progress_page %}
        <tr>
            <td>{{ progress.progress_code|default:''  }}</td>
            <td>{{ progress.work_date|date:"d/m/Y"|default:''  }}</td>
            <td>
              {% if progress.tailor.short_name %}
                {% with progress.tailor.short_name|slice:"2:"|first|lower as first_letter %}
                  <span class="employee-custom employee-c-{{ first_letter }}">
                    {{ progress.tailor.short_name }}
                  </span>
                {% endwith %}
              {% endif %}
            </td>            
            <td>{{ progress.design.design_name|default:''  }}</td>
            <td>{{ progress.task_name|default:''  }}</td>
            <td>{{ progress.start_time|time:"H:i" }}</td>
            <td>{{ progress.end_time|time:"H:i" }}</td>
            <td>
                {{ progress.main_fabric_meters|default:'' }} <br>
                <span style="color: rgb(165, 165, 165);">
                    {{ progress.lining_fabric_meters|default:'' }}
                </span>
            </td>
            
            <td>    
                {% if progress.status == 'Completed' %}
                <span class="btn-order-complete">
                    Hoàn thành
                </span>
                {% elif progress.status == 'In Progress' %}
                <span class="btn-order-cancel">
                    Dở dang
                </span>
                {% endif %}
            </td>
            <td>
                <a href="#" class="icon-table" data-bs-toggle="modal" data-bs-target="#modalUpdate{{ progress.progress_code }}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                </svg>              
                </a>
                <a href="#" class="icon-table" data-bs-toggle="modal" data-bs-target="#modalDelete{{ progress.progress_code }}">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="16" height="16">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                </svg>              
                </a>
            </td>
        </tr>

        <!-- Modal detail nhân viên -->
        <div class="modal fade" id="modalDetail{{ progress.progress_code }}" tabindex="-1" aria-labelledby="modalDetailLabel{{ progress.progress_code }}" aria-hidden="true">
          <div class="modal-dialog" role="document" style="max-width: 800px; width: 100%; height: 360px;">
            <div class="modal-content" style="height: 100%; overflow-y: auto;">
                  <div class="modal-header">
                      <h5 class="modal-title" id="modalDetailLabel{{ progress.progress_code }}" class="personal-info">{{ progress.progress_code }} | {{ employee.employee_name }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="container">
                      <div class="row">
                        <div class="col-md-4">
                          {% if employee.image %}
                            <img src="{{ employee.image.url }}" alt="Hình ảnh nguyên vật liệu" class="img-fluid" style="max-width: 220px; max-height: 180px;">
                          {% else %}
                            <img src="/media/employee_images/employee.jpg" alt="Không có hình ảnh" class="img-fluid" style="max-width: 220px; max-height: 180px;">
                          {% endif %}
                        </div>
                        <div class="col-md-8">
                          <div class="row mb-2">
                            <div class="col-md-4" style="white-space: nowrap;">
                              <strong>Họ và tên:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>{{ employee.employee_name|default:'-' }}</span>
                            </div>
                          </div>
                          <div class="row mb-2">
                            <div class="col-md-4" style="white-space: nowrap;">
                              <strong>Ngày sinh:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>{{ employee.date_of_birth|date:"d/m/Y"|default:'-' }}</span>
                            </div>
                          </div>
                          <div class="row mb-2">
                            <div class="col-md-4">
                              <strong>Giới tính:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>{{ employee.gender|default:'-' }}</span>
                            </div>
                          </div>
                          <div class="row mb-2">
                            <div class="col-md-4">
                              <strong>Số điện thoại:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>{{ employee.phone_number|default:'-' }}</span>
                            </div>
                          </div>
                          <div class="row mb-2">
                            <div class="col-md-4">
                              <strong>Phòng ban:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>{{ employee.department|default:'-' }}</span>
                            </div>
                          </div>
                          <div class="row mb-2">
                            <div class="col-md-4">
                              <strong>Chức vụ:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>{{ employee.position|default:'-' }}</span>
                            </div>
                          </div>
                          <div class="row mb-2">
                            <div class="col-md-4">
                              <strong>Trạng thái làm việc:</strong>
                            </div>
                            <div class="col-md-8">
                              <span>
                                {% if employee.employment_status == "active" %}
                                    Đang làm việc
                                {% elif employee.employment_status == "inactive" %}
                                    Đã nghỉ việc
                                {% endif %}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                      <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Đóng</button>
                  </div>
              </div>
          </div>
        </div>

          <!-- Modal update -->
          <div class="modal fade" id="modalUpdate{{ progress.progress_code }}" tabindex="-1" aria-labelledby="modalUpdateLabel{{ progress.progress_code }}" aria-hidden="true">
            <div class="modal-dialog" role="document" style="max-width: 800px; width: 100%; height: 470px;">
              <div class="modal-content" style="height: 100%; overflow-y: auto;">
                  <form id="uploadFileForm" method="post" action="" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                      <h5 class="modal-title" id="updateCategoryModalLabel">Điều chỉnh Nhân viên</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="height: calc(100% - 125px); overflow-y: auto;">
                        <div class="row mb-2">
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="progress_code">Mã tiến độ:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <input type="text" id="progress_code" name="progress_code" class="form-control custom-input" value="{{ progress.progress_code }}" readonly>
                          </div>
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="work_date">Ngày làm việc:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <input type="date" id="work_date" name="work_date" class="form-control custom-input" value="{{ progress.work_date|date:'Y-m-d' }}">
                          </div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="tailor">Thợ may:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <select id="tailor" name="tailor" class="form-control" required>
                                  <option value="{{ progress.tailor.employee_code }} - {{ progress.tailor.employee_name }}">{{ progress.tailor.employee_name }}</option>
                                  <option value="">-- Chọn thợ may --</option>
                                  {% for employee in employees %}
                                  <option value="{{ employee.employee_code }} - {{ employee.employee_name }}">{{ employee.employee_name }}</option>
                                  {% endfor %}
                              </select>
                          </div>
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="edit_design">MTK:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <select id="edit_design" name="edit_design" class="form-control">
                                  <option value="{{ progress.design.design_code }} - {{ progress.design.design_name }}"
                                          data-colors="{% for cid in progress.design.colorindesign_set.all %}{{ cid.color.color_name }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                          data-sizes="{% for sid in progress.design.sizeindesign_set.all %}{{ sid.size.size_name }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                          data-selected-color="{{ progress.color }}"
                                          data-selected-size="{{ progress.size }}">
                                      {{ progress.design.design_name }}
                                  </option>
                                  <option value="">-- Chọn MTK --</option>
                                  {% for design_item in designs %}
                                      <option value="{{ design_item.design.design_code }} - {{ design_item.design.design_name }}" 
                                              data-colors="{{ design_item.colors|join:',' }}" 
                                              data-sizes="{{ design_item.sizes|join:',' }}">
                                          {{ design_item.design.design_name }}
                                      </option>
                                  {% endfor %}
                              </select>
                          </div>
                          </div>
                          <div class="row mb-2">
                              <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                                  <label for="edit_color">Màu:</label>
                              </div>
                              <div class="col-md-4 d-flex align-items-center">
                                  <select id="edit_color" name="edit_color" class="form-control" required>
                                      <option value="{{ progress.color }}">{{ progress.color }}</option>
                                      <option value="">-- Chọn Màu --</option>
                                  </select>
                              </div>
                              <div class="col-md-2 d-flex align-items-center">
                                  <label for="edit_size">Size:</label>
                              </div>
                              <div class="col-md-4 d-flex align-items-center">
                                  <select id="edit_size" name="edit_size" class="form-control" required>
                                      <option value="{{ progress.size }}">{{ progress.size }}</option>
                                      <option value="">-- Chọn Size --</option>
                                  </select>
                              </div>
                          </div>
                      <div class="row mb-2 align-items-start">
                          <div class="col-md-2">
                              <label for="edit_design_name" class="form-label">Tên thiết kế:</label>
                          </div>
                          <div class="col-md-10">
                              <input type="text" id="edit_design_name" name="edit_design_name" class="form-control custom-input" value="{{ progress.design_name }}" readonly>
                          </div>
                      </div>          
                      <hr color="#dee2e6">            
                      <div class="row mb-2">
                          <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                              <label for="task_name">Công việc đã làm:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <select id="task_name" name="task_name" class="form-control" required>
                                <option value="{{ progress.task_name }}">{{ progress.task_name }}</option>
                                  <option value="">-- Chọn Công việc đã làm --</option>
                                  <option value="Cắt rập">Cắt rập</option>  
                                  <option value="Cắt vải">Cắt vải</option>
                                  <option value="Sửa đồ cho khách">Sửa đồ cho khách</option>
                                  <option value="May mẫu">May mẫu</option>
                                  <option value="Sửa mẫu">Sửa mẫu</option>
                              </select>
                          </div>
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="fabric">Số mét vải đã cắt:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <input type="number" id="main_fabric_meters" name="main_fabric_meters" class="form-control me-2" placeholder="Vải chính" min="0" value="{{ progress.main_fabric_meters }}">
                                    <input type="number" id="lining_fabric_meters" name="lining_fabric_meters" class="form-control" placeholder="Vải lót" min="0" value="{{ progress.lining_fabric_meters }}">
                          </div>
                      </div>
                      <div class="row mb-2">
                          <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                              <label for="start_time">Bắt đầu:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <input type="time" id="start_time" name="start_time" class="form-control"  value="{{ progress.start_time|time:'H:i' }}">
                          </div>
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="end_time">Kết thúc:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <input type="time" id="end_time" name="end_time" class="form-control" value="{{ progress.end_time|time:'H:i' }}">
                          </div>
                      </div>                        
                      <div class="row mb-2">
                          <div class="col-md-2 d-flex align-items-center" style="white-space: nowrap;">
                              <label for="status">Trạng thái:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <select id="status" name="status" class="form-control" required>
                                  <option value="{{ progress.status }}">
                                    {% if progress.status == "Completed" %}
                                            Hoàn thành
                                    {% elif progress.status == "In Progress" %}
                                            Dở dang
                                    {% endif %}
                                  </option>
                                  <option value="">-- Chọn Trạng thái --</option>
                                  <option value="In Progress">Dang dở</option>  
                                  <option value="Completed">Hoàn thành</option>
                              </select>
                          </div>
                          <div class="col-md-2 d-flex align-items-center">
                              <label for="notes">Ghi chú:</label>
                          </div>
                          <div class="col-md-4 d-flex align-items-center">
                              <input type="text" id="notes" name="notes" class="form-control custom-input" value="{{ progress.notes }}">
                          </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn cancel-btn" data-bs-dismiss="modal" style="width: 150px;">Hủy</button>
                      <button type="submit" class="btn submit-btn" id="submitUpdateProgressBtn" data-progress-code="{{ progress.progress_code }}" style="width: 150px;">Chỉnh sửa & Đóng</button>
                    </div>
                  </form>
                </div>
            </div>
          </div>

          <!-- Modal delete -->
          <div class="modal fade" id="modalDelete{{ progress.progress_code }}" tabindex="-1" aria-labelledby="modalDeleteLabel{{ progress.progress_code }}" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                  <form id="uploadFileForm" method="post" action="" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteCategoryModalLabel">Xóa phiếu tiến độ</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p>Bạn chắc chắn muốn xóa phiếu tiến độ <strong>{{ progress.progress_code }}</strong>?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn cancel-btn" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn submit-btn" id="submitDeleteProgressBtn" data-progress-code="{{ progress.progress_code }}">Xóa & Đóng</button>
                    </div>
                  </form>
                </div>
            </div>
          </div>

        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <p>Không có bất kỳ nhà cung cấp nào.</p>
  {% endif %}
  <nav aria-label="Page navigation example">
    <ul class="pagination justify-content-center">
        {% if progress_page.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ progress_page.previous_page_number }}&sort_field={{ current_sort_field }}&sort_order={{ current_sort_order }}&search={{ search_query }}" aria-label="Previous">
                    <span aria-hidden="true">&lsaquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Previous">
                    <span aria-hidden="true">&lsaquo;</span>
                </a>
            </li>
        {% endif %}

        {% for num in progress_page.paginator.page_range %}
            {% if progress_page.number == num %}
                <li class="page-item active">
                    <a class="page-link" href="?page={{ num }}&sort_field={{ current_sort_field }}&sort_order={{ current_sort_order }}&search={{ search_query }}">{{ num }}</a>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}&sort_field={{ current_sort_field }}&sort_order={{ current_sort_order }}&search={{ search_query }}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if progress_page.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ progress_page.next_page_number }}&sort_field={{ current_sort_field }}&sort_order={{ current_sort_order }}&search={{ search_query }}" aria-label="Next">
                    <span aria-hidden="true">&rsaquo;</span>
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <a class="page-link" href="#" aria-label="Next">
                    <span aria-hidden="true">&rsaquo;</span>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>

</main>


<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
<script>
  $(document).ready(function() {

    document.getElementById('search-input').addEventListener('keyup', function(event) {
        if (event.key === 'Enter') { 
            const searchValue = this.value;
            const url = new URL(window.location.href);
            url.searchParams.set('search', searchValue);
            url.searchParams.set('page', 1); 
            window.location.href = url.toString();
        }
    });

    ///////////////////////////
    ///////////////////////////
    ///////////////////////////


    $(document).ready(function () {
        console.log("Script đã tải thành công!");

        let designSelect = $("#design");
        let colorSelect = $("#color");
        let sizeSelect = $("#size");
        let designNameInput = $("#design_name");

        function updateDesignName() {
            let selectedDesign = designSelect.find(":selected").text().trim();
            let selectedColor = colorSelect.find(":selected").text().trim();
            let selectedSize = sizeSelect.find(":selected").text().trim();
            
            if (selectedDesign && selectedColor && selectedSize && selectedColor !== "-- Chọn Màu --" && selectedSize !== "-- Chọn Size --") {
                designNameInput.val(`${selectedDesign} (${selectedColor} - ${selectedSize})`.replace(/\s+/g, " ").trim());
            } else {
                designNameInput.val("");
            }
        }

        designSelect.change(function () {
            let selectedOption = $(this).find(":selected");

            if (!selectedOption.val()) {
                console.log("Không có MTK nào được chọn!");
                return;
            }

            let colors = selectedOption.data("colors") ? selectedOption.data("colors").split(",") : [];
            let sizes = selectedOption.data("sizes") ? selectedOption.data("sizes").split(",") : [];

            console.log("MTK được chọn:", selectedOption.text());
            console.log("Danh sách màu:", colors);
            console.log("Danh sách size:", sizes);

            colorSelect.empty().append('<option value="">-- Chọn Màu --</option>');
            sizeSelect.empty().append('<option value="">-- Chọn Size --</option>');

            colors.forEach(function (color) {
                if (color.trim() !== "") {
                    colorSelect.append(new Option(color, color));
                }
            });

            sizes.forEach(function (size) {
                if (size.trim() !== "") {
                    sizeSelect.append(new Option(size, size));
                }
            });

            console.log("Dropdown Màu và Size đã được cập nhật!");
        });

        colorSelect.change(updateDesignName);
        sizeSelect.change(updateDesignName);
    });

    ///////////////////////////
    ///////////////////////////
    ///////////////////////////

    $(document).ready(function () {
    console.log("Script cho modal sửa phiếu đã tải thành công!");

    $("[id^=modalUpdate]").on("shown.bs.modal", function () {
        console.log("Modal sửa phiếu đã mở!");

        let modal = $(this);
        let editDesignSelect = modal.find("#edit_design");
        let editColorSelect = modal.find("#edit_color");
        let editSizeSelect = modal.find("#edit_size");
        let editDesignNameInput = modal.find("#edit_design_name");

        function updateEditDesignName() {
            let selectedDesign = editDesignSelect.find(":selected").text().trim();
            let selectedColor = editColorSelect.find(":selected").text().trim();
            let selectedSize = editSizeSelect.find(":selected").text().trim();
            
            if (selectedDesign && selectedColor && selectedSize && selectedColor !== "-- Chọn Màu --" && selectedSize !== "-- Chọn Size --") {
                editDesignNameInput.val(`${selectedDesign} (${selectedColor} - ${selectedSize})`.replace(/\s+/g, " ").trim());
            } else {
                editDesignNameInput.val("");
            }
        }

        function populateDropdown(selectElement, options, selectedValue) {
            options.forEach(function (option) {
                let isSelected = option === selectedValue ? "selected" : "";
                selectElement.append(`<option value="${option}" ${isSelected}>${option}</option>`);
            });
        }

        function initializeDropdowns() {
            let selectedOption = editDesignSelect.find(":selected");
            if (!selectedOption.val()) return;

            let colors = selectedOption.data("colors") ? selectedOption.data("colors").split(",") : [];
            let sizes = selectedOption.data("sizes") ? selectedOption.data("sizes").split(",") : [];

            let currentColor = editDesignSelect.find(":selected").attr("data-selected-color") || colors[0] || "";
            let currentSize = editDesignSelect.find(":selected").attr("data-selected-size") || sizes[0] || "";

            console.log("Thiết lập mặc định - MTK:", selectedOption.text());
            console.log("Danh sách màu:", colors);
            console.log("Danh sách size:", sizes);
            console.log("Màu mặc định:", currentColor);
            console.log("Size mặc định:", currentSize);

            populateDropdown(editColorSelect, colors, currentColor);
            populateDropdown(editSizeSelect, sizes, currentSize);
        }

        editDesignSelect.change(function () {
            let selectedOption = $(this).find(":selected");
            if (!selectedOption.val()) {
                console.log("Không có MTK nào được chọn!");
                return;
            }

            let colors = selectedOption.data("colors") ? selectedOption.data("colors").split(",") : [];
            let sizes = selectedOption.data("sizes") ? selectedOption.data("sizes").split(",") : [];

            console.log("MTK được chọn:", selectedOption.text());
            console.log("Danh sách màu:", colors);
            console.log("Danh sách size:", sizes);

            editColorSelect.empty().append('<option value="">-- Chọn Màu --</option>');
            editSizeSelect.empty().append('<option value="">-- Chọn Size --</option>');

            populateDropdown(editColorSelect, colors, colors[0] || "");
            populateDropdown(editSizeSelect, sizes, sizes[0] || "");

            console.log("Dropdown Màu và Size đã được cập nhật khi thay đổi MTK!");
        });


        editColorSelect.change(updateEditDesignName);
        editSizeSelect.change(updateEditDesignName);

        initializeDropdowns();
    });
});

    
    ///////////////////////////
    ///////////////////////////
    ///////////////////////////

    $('#submitUploadFileBtn').click(function(e) {
      e.preventDefault();

      var url = '{% url "catalog:upload_progress" %}';
      var csrftoken = '{{ csrf_token }}';
      var fileInput = document.getElementById('file').files[0];
      var sheetUrl = document.getElementById('sheetUrl').value;
      var formData = new FormData();

      if (fileInput) {
        formData.append('file', fileInput);
      } else if (sheetUrl) {
        formData.append('sheetUrl', sheetUrl);
      } else {
        alert("Vui lòng chọn file hoặc nhập URL của Google Sheets.");
        return;
      }

      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': csrftoken,
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        console.log(data);
        alert("Tệp đã được tải lên và xử lý thành công");
        $('#uploadFileModal').modal('hide');
        window.location.reload(); 
      })
      .catch(error => {
        console.error('Error:', error);
        alert("Đã xảy ra lỗi khi xử lý tệp.");
      });
    });

    ///////////////////////////
    ///////////////////////////
    ///////////////////////////
    
    $('#submitAddProgressBtn').click(function(e) {
        e.preventDefault();

        var url = '{% url "catalog:create_progress" %}';
        var csrftoken = '{{ csrf_token }}';

        var progressData = new FormData();
        progressData.append('progress_code', $('#progress_code').val());
        progressData.append('work_date', $('#work_date').val());
        progressData.append('tailor', $('#tailor').val());
        progressData.append('design', $('#design').val());
        progressData.append('color', $('#color').val());
        progressData.append('size', $('#size').val());
        progressData.append('design_name', $('#design_name').val());
        progressData.append('task_name', $('#task_name').val());
        progressData.append('main_fabric_meters', $('#main_fabric_meters').val());
        progressData.append('lining_fabric_meters', $('#lining_fabric_meters').val());
        progressData.append('start_time', $('#start_time').val());
        progressData.append('end_time', $('#end_time').val());
        progressData.append('status', $('#status').val());
        progressData.append('notes', $('#notes').val());

        console.log("Dữ liệu tiến độ trước khi gửi:");
        for (var pair of progressData.entries()) {
            console.log(pair[0] + ':', pair[1]);
        }


        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: progressData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Phản hồi từ server:", data);
            alert("Phiêu tiến độ mới đã được tạo thành công!");
            location.reload();
        })
        .catch(error => {
            console.error('Lỗi:', error);
            alert("Đã xảy ra lỗi khi thêm phiếu tiến độ mới.");
        });
    });


    ///////////////////////////
    ///////////////////////////
    ///////////////////////////

    $(document).on('click', '#submitDeleteProgressBtn', function(e) {
        e.preventDefault();
        let progress_code = $(this).data('progress-code');
        console.log("Progress Code:", progress_code);

        let url = '{% url "catalog:delete_progress" progress_code="PROGRESS_CODE" %}';
        url = url.replace("PROGRESS_CODE", progress_code);
        let csrftoken = '{{ csrf_token }}';
        
        fetch(url, {
            method: 'POST', 
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body: JSON.stringify({ progress_code: progress_code })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => { throw new Error(data.error || 'Có lỗi xảy ra'); });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message || "Nhân viên đã được xóa thành công!");
            location.reload(); 
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || "Đã xảy ra lỗi khi xóa nhân viên.");
        });
        });

    // ///////////////////////////
    // ///////////////////////////
    // ///////////////////////////

    $(document).on('click', '#submitUpdateProgressBtn', function(e) {
        e.preventDefault();

        var modal = $(this).closest('.modal');

        let progress_code = $(this).data('progress-code');
        console.log("Progress Code:", progress_code);

        let url = '{% url "catalog:update_progress" progress_code="PROGRESS_CODE" %}';
        url = url.replace("PROGRESS_CODE", progress_code);
        let csrftoken = '{{ csrf_token }}';


        var progressData = new FormData();
        progressData.append('progress_code', modal.find('#progress_code').val());
        progressData.append('work_date', modal.find('#work_date').val());
        progressData.append('tailor', modal.find('#tailor').val());
        progressData.append('design', modal.find('#edit_design').val());
        progressData.append('color', modal.find('#edit_color').val());
        progressData.append('size', modal.find('#edit_size').val());
        progressData.append('design_name', modal.find('#edit_design_name').val());

        progressData.append('task_name', modal.find('#task_name').val());
        progressData.append('main_fabric_meters', modal.find('#main_fabric_meters').val());
        progressData.append('lining_fabric_meters', modal.find('#lining_fabric_meters').val());
        progressData.append('start_time', modal.find('#start_time').val());
        progressData.append('end_time', modal.find('#end_time').val());
        progressData.append('status', modal.find('#status').val());
        progressData.append('notes', modal.find('#notes').val());

        console.log("Dữ liệu progress trước khi gửi:");
        for (var pair of progressData.entries()) {
            console.log(pair[0] + ":", pair[1]);
        }


        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: progressData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Phản hồi từ server:", data);
            alert("Phiếu tiến độ đã được cập nhật thành công!");
            location.reload();
        })
        .catch(error => {
            console.error('Lỗi:', error);
            alert("Đã xảy ra lỗi khi cập nhật phiếu tiến độ.");
        });
    });


  });
</script>
{% endblock %}

